-- Ultimate Utility GUI : AntiFling, Set Spawn (2 จุด), AutoTP (HP<10%), DiedTP, Drag GUI, Hide/Show GUI, Custom Hotkey
-- Inspired by Infinite Yield (no code copied), fully written for safety and customization.
-- วางใน LocalScript (StarterPlayerScripts) หรือ Executor ที่รองรับ

local player = game.Players.LocalPlayer
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "UltimateUtilityGUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 370, 0, 330)
frame.Position = UDim2.new(0, 40, 0, 110)
frame.BackgroundColor3 = Color3.fromRGB(26, 29, 36)
frame.BackgroundTransparency = 0.1
frame.BorderSizePixel = 0

-- DRAGGABLE GUI (drag by title bar)
local UserInputService = game:GetService("UserInputService")
local dragging, dragInput, dragStart, startPos = false, nil, nil, nil
frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 and input.Position.Y - frame.AbsolutePosition.Y < 36 then -- drag only title bar
		dragging = true
		dragStart = input.Position
		startPos = frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)
frame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement then
		dragInput = input
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

-- Hide/Show GUI Button
local hideBtn = Instance.new("TextButton", gui)
hideBtn.Size = UDim2.new(0, 36, 0, 36)
hideBtn.Position = UDim2.new(0, 10, 0, 60)
hideBtn.BackgroundColor3 = Color3.fromRGB(36, 38, 49)
hideBtn.Text = "⏷"
hideBtn.Font = Enum.Font.GothamBold
hideBtn.TextSize = 19
hideBtn.TextColor3 = Color3.fromRGB(255, 222, 110)
hideBtn.AutoButtonColor = true
hideBtn.ZIndex = 2

local guiVisible = true
local function setGuiVisible(state)
    guiVisible = state
    frame.Visible = guiVisible
    hideBtn.Text = guiVisible and "⏷" or "⏵"
end
hideBtn.MouseButton1Click:Connect(function()
    setGuiVisible(not guiVisible)
end)

-- Title bar
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 36)
title.Position = UDim2.new(0, 0, 0, 0)
title.Text = "Ultimate Utility GUI"
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 235, 110)

local y = 44

-- Helper: สถานะวงกลม
local function makeStatusCircle(parent, color, y)
    local cir = Instance.new("Frame", parent)
    cir.Size = UDim2.new(0, 16, 0, 16)
    cir.Position = UDim2.new(0, 10, 0, y)
    cir.BackgroundColor3 = color
    cir.BorderSizePixel = 0
    cir.Name = "StatusCircle"
    local uicorner = Instance.new("UICorner", cir)
    uicorner.CornerRadius = UDim.new(1,0)
    return cir
end

-- 1. AntiFling
local antiflingCircle = makeStatusCircle(frame, Color3.fromRGB(210, 50, 50), y+2)
local antiflingBtn = Instance.new("TextButton", frame)
antiflingBtn.Size = UDim2.new(0, 120, 0, 24)
antiflingBtn.Position = UDim2.new(0, 32, 0, y)
antiflingBtn.Text = "AntiFling : ปิด"
antiflingBtn.Font = Enum.Font.GothamBold
antiflingBtn.TextSize = 14
antiflingBtn.BackgroundColor3 = Color3.fromRGB(48, 54, 68)
antiflingBtn.TextColor3 = Color3.new(1,1,1)

-- 2. Auto TP (Teleport เมื่อเลือดต่ำ) [Set จุดแยก]
y = y + 38
local autotpcircle = makeStatusCircle(frame, Color3.fromRGB(210, 50, 50), y+2)
local autotpswitch = Instance.new("TextButton", frame)
autotpswitch.Size = UDim2.new(0, 120, 0, 24)
autotpswitch.Position = UDim2.new(0, 32, 0, y)
autotpswitch.Text = "AutoTP : ปิด"
autotpswitch.Font = Enum.Font.GothamBold
autotpswitch.TextSize = 14
autotpswitch.BackgroundColor3 = Color3.fromRGB(48, 54, 68)
autotpswitch.TextColor3 = Color3.new(1,1,1)

local autosetBtn = Instance.new("TextButton", frame)
autosetBtn.Size = UDim2.new(0, 90, 0, 24)
autosetBtn.Position = UDim2.new(0, 160, 0, y)
autosetBtn.Text = "Set AutoTP"
autosetBtn.Font = Enum.Font.GothamBold
autosetBtn.TextSize = 13
autosetBtn.BackgroundColor3 = Color3.fromRGB(56, 100, 125)
autosetBtn.TextColor3 = Color3.new(1,1,1)

local autotpinfo = Instance.new("TextLabel", frame)
autotpinfo.Size = UDim2.new(1, -260, 0, 24)
autotpinfo.Position = UDim2.new(0, 255, 0, y)
autotpinfo.Text = "ยังไม่ตั้งจุด"
autotpinfo.Font = Enum.Font.Gotham
autotpinfo.TextSize = 12
autotpinfo.TextColor3 = Color3.fromRGB(180,220,220)
autotpinfo.BackgroundTransparency = 1
autotpinfo.TextXAlignment = Enum.TextXAlignment.Left

-- 3. Set Spawn (จุดเกิดเอง)
y = y + 38
local spawnCircle = makeStatusCircle(frame, Color3.fromRGB(210, 210, 50), y+2)
local spawnBtn = Instance.new("TextButton", frame)
spawnBtn.Size = UDim2.new(0, 120, 0, 24)
spawnBtn.Position = UDim2.new(0, 32, 0, y)
spawnBtn.Text = "Set Spawn"
spawnBtn.Font = Enum.Font.GothamBold
spawnBtn.TextSize = 14
spawnBtn.BackgroundColor3 = Color3.fromRGB(48, 54, 68)
spawnBtn.TextColor3 = Color3.new(1,1,1)

local spawnInfo = Instance.new("TextLabel", frame)
spawnInfo.Size = UDim2.new(1, -160, 0, 24)
spawnInfo.Position = UDim2.new(0, 160, 0, y)
spawnInfo.Text = "ยังไม่ตั้งจุดเกิด"
spawnInfo.Font = Enum.Font.Gotham
spawnInfo.TextSize = 12
spawnInfo.TextColor3 = Color3.fromRGB(255,255,110)
spawnInfo.BackgroundTransparency = 1
spawnInfo.TextXAlignment = Enum.TextXAlignment.Left

-- 4. DiedTP
y = y + 38
local diedtpCircle = makeStatusCircle(frame, Color3.fromRGB(210, 50, 50), y+2)
local diedtpBtn = Instance.new("TextButton", frame)
diedtpBtn.Size = UDim2.new(0, 120, 0, 24)
diedtpBtn.Position = UDim2.new(0, 32, 0, y)
diedtpBtn.Text = "DiedTP"
diedtpBtn.Font = Enum.Font.GothamBold
diedtpBtn.TextSize = 14
diedtpBtn.BackgroundColor3 = Color3.fromRGB(48, 54, 68)
diedtpBtn.TextColor3 = Color3.new(1,1,1)

local diedtpInfo = Instance.new("TextLabel", frame)
diedtpInfo.Size = UDim2.new(1, -160, 0, 24)
diedtpInfo.Position = UDim2.new(0, 160, 0, y)
diedtpInfo.Text = "ยังไม่ตาย"
diedtpInfo.Font = Enum.Font.Gotham
diedtpInfo.TextSize = 12
diedtpInfo.TextColor3 = Color3.fromRGB(240,180,180)
diedtpInfo.BackgroundTransparency = 1
diedtpInfo.TextXAlignment = Enum.TextXAlignment.Left

-- 5. Hotkey Setting
y = y + 38
local hotkeyLabel = Instance.new("TextLabel", frame)
hotkeyLabel.Size = UDim2.new(1, -20, 0, 18)
hotkeyLabel.Position = UDim2.new(0, 10, 0, y)
hotkeyLabel.Text = "🌟 ตั้งค่าปุ่มลัด (คลิกปุ่มแล้วกดคีย์ที่ต้องการ)"
hotkeyLabel.Font = Enum.Font.Gotham
hotkeyLabel.TextSize = 12
hotkeyLabel.TextColor3 = Color3.fromRGB(255,255,200)
hotkeyLabel.BackgroundTransparency = 1
y = y + 18

local hotkeyBtns = {}
local hotkeyFields = {
    {name="AntiFling", field="antifling", def=Enum.KeyCode.Q, ref=antiflingBtn},
    {name="AutoTP", field="autotp", def=Enum.KeyCode.T, ref=autotpswitch},
    {name="Set Spawn", field="spawn", def=Enum.KeyCode.K, ref=spawnBtn},
    {name="Set AutoTP", field="autoset", def=Enum.KeyCode.U, ref=autosetBtn},
    {name="DiedTP", field="diedtp", def=Enum.KeyCode.G, ref=diedtpBtn},
    {name="Toggle GUI", field="toggle", def=Enum.KeyCode.F1, ref=hideBtn},
}
local hotkeys = {}
for i, hk in ipairs(hotkeyFields) do
    hotkeys[hk.field] = hk.def
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.new(0, 86, 0, 20)
    btn.Position = UDim2.new(0, 12 + ((i-1)%4)*90, 0, y + math.floor((i-1)/4)*24)
    btn.Text = hk.def.Name
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 11
    btn.TextColor3 = Color3.new(.9,.9,.9)
    btn.BackgroundColor3 = Color3.fromRGB(70, 80, 100)
    btn.AutoButtonColor = true
    hotkeyBtns[hk.field] = btn

    btn.MouseButton1Click:Connect(function()
        btn.Text = "กดคีย์..."
        local con
        con = UserInputService.InputBegan:Connect(function(input, gp)
            if not gp and input.KeyCode ~= Enum.KeyCode.Unknown then
                hotkeys[hk.field] = input.KeyCode
                btn.Text = input.KeyCode.Name
                con:Disconnect()
            end
        end)
    end)
end

-- ท้ายสุด
local tip = Instance.new("TextLabel", frame)
tip.Size = UDim2.new(1, -20, 0, 28)
tip.Position = UDim2.new(0, 10, 0, 294)
tip.Text = "ลาก GUI ได้ | Hide GUI | ตั้งค่าปุ่มลัดเอง"
tip.Font = Enum.Font.Gotham
tip.TextSize = 12
tip.TextColor3 = Color3.fromRGB(200,255,190)
tip.BackgroundTransparency = 1

---------------------------- LOGIC ----------------------------

-- 1. AntiFling
local antiflingEnabled = false
local function setAntiFling(state)
    antiflingEnabled = state
    antiflingBtn.Text = "AntiFling : " .. (state and "เปิด" or "ปิด")
    antiflingCircle.BackgroundColor3 = state and Color3.fromRGB(80,210,80) or Color3.fromRGB(210,50,50)
end
antiflingBtn.MouseButton1Click:Connect(function()
    setAntiFling(not antiflingEnabled)
end)
spawn(function()
    while true do
        task.wait(0.2)
        if antiflingEnabled then
            local char = player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local hrp = char.HumanoidRootPart
                if math.abs(hrp.Velocity.X) > 120 or math.abs(hrp.Velocity.Y) > 120 or math.abs(hrp.Velocity.Z) > 120 then
                    hrp.Velocity = Vector3.new(0, 0, 0)
                end
                if math.abs(hrp.RotVelocity.X) > 50 or math.abs(hrp.RotVelocity.Y) > 50 or math.abs(hrp.RotVelocity.Z) > 50 then
                    hrp.RotVelocity = Vector3.new(0, 0, 0)
                end
            end
        end
    end
end)

-- 2. AutoTP (เลือดต่ำวาป: จุดแยกจาก Spawn)
local autotpenabled = false
local teleporting = false
local autotpPos
local autoTP_HUMANOID = nil

local function updateAutoTPInfo()
    if autotpPos then
        autotpinfo.Text = string.format("X:%.1f Y:%.1f Z:%.1f", autotpPos.X, autotpPos.Y, autotpPos.Z)
        autotpinfo.TextColor3 = Color3.fromRGB(80,210,80)
    else
        autotpinfo.Text = "ยังไม่ตั้งจุด"
        autotpinfo.TextColor3 = Color3.fromRGB(180,220,220)
    end
end

local function setAutoTP(state)
    autotpenabled = state
    autotpswitch.Text = "AutoTP : " .. (state and "เปิด" or "ปิด")
    autotpcircle.BackgroundColor3 = state and Color3.fromRGB(80,210,80) or Color3.fromRGB(210,50,50)
end
autotpswitch.MouseButton1Click:Connect(function()
    setAutoTP(not autotpenabled)
end)
autosetBtn.MouseButton1Click:Connect(function()
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        autotpPos = char.HumanoidRootPart.Position
        updateAutoTPInfo()
    end
end)
updateAutoTPInfo()

-- 3. Set Spawn
local spawnPos
spawnBtn.MouseButton1Click:Connect(function()
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        spawnPos = char.HumanoidRootPart.Position
        spawnCircle.BackgroundColor3 = Color3.fromRGB(80,210,80)
        spawnInfo.Text = string.format("X:%.1f Y:%.1f Z:%.1f", spawnPos.X, spawnPos.Y, spawnPos.Z)
        spawnInfo.TextColor3 = Color3.fromRGB(80,210,80)
    end
end)
player.CharacterAdded:Connect(function(char)
    wait(0.1)
    if spawnPos then
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then hrp.CFrame = CFrame.new(spawnPos) end
    end
    -- Setup AutoTP ใหม่ทุกครั้งที่เกิด
    if autoTP_HUMANOID then
        pcall(function() autoTP_HUMANOID.HealthChanged:Disconnect() end)
    end
    autoTP_HUMANOID = char:FindFirstChildOfClass("Humanoid")
    if autoTP_HUMANOID then
        autoTP_HUMANOID.HealthChanged:Connect(function(health)
            if autotpenabled and autotpPos and health > 0 and (health / autoTP_HUMANOID.MaxHealth) <= 0.1 and not teleporting and autoTP_HUMANOID:GetState() ~= Enum.HumanoidStateType.Dead then
                teleporting = true
                local c = player.Character
                if c and c:FindFirstChild("HumanoidRootPart") then
                    c.HumanoidRootPart.CFrame = CFrame.new(autotpPos)
                end
                autotpinfo.Text = "วาร์ปฉุกเฉิน (HP<10%)"
                wait(0.5)
                teleporting = false
                updateAutoTPInfo()
            end
        end)
    end
end)

-- 4. DiedTP
local deathPos
player.CharacterAdded:Connect(function(char)
    local hum = char:WaitForChild("Humanoid")
    hum.Died:Connect(function()
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            deathPos = hrp.Position
            diedtpCircle.BackgroundColor3 = Color3.fromRGB(80,210,80)
            diedtpInfo.Text = string.format("X:%.1f Y:%.1f Z:%.1f", deathPos.X, deathPos.Y, deathPos.Z)
            diedtpInfo.TextColor3 = Color3.fromRGB(80,210,80)
        end
    end)
end)
diedtpBtn.MouseButton1Click:Connect(function()
    local char = player.Character
    if deathPos and char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(deathPos)
    end
end)

-- HOTKEYS
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    for field, key in pairs(hotkeys) do
        if input.KeyCode == key then
            if field == "antifling" then antiflingBtn:Activate()
            elseif field == "autotp" then autotpswitch:Activate()
            elseif field == "spawn" then spawnBtn:Activate()
            elseif field == "autoset" then autosetBtn:Activate()
            elseif field == "diedtp" then diedtpBtn:Activate()
            elseif field == "toggle" then hideBtn:Activate()
            end
        end
    end
end)
