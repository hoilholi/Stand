-- Ultimate Utility GUI (Freecam WASD สมดุล, ยกเลิก Freecam ได้, ปรับสปีด, ตั้งปุ่มลัด, GUI แยกฟีเจอร์)
-- ฟีเจอร์: AntiFling, AutoTP, Set Spawn, DiedTP, Drag GUI, AntiIdle/Freecam/Reset

local player = game.Players.LocalPlayer
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "UltimateUtilityGUI"
gui.ResetOnSpawn = false

-- Main Utility Frame
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 360, 0, 170)
frame.Position = UDim2.new(0, 40, 0, 110)
frame.BackgroundColor3 = Color3.fromRGB(26, 29, 36)
frame.BackgroundTransparency = 0.13
frame.BorderSizePixel = 0

-- New Command Frame (for AntiIdle, Freecam, Reset)
local cmdFrame = Instance.new("Frame", gui)
cmdFrame.Size = UDim2.new(0, 210, 0, 110)
cmdFrame.Position = UDim2.new(0, 410, 0, 40)
cmdFrame.BackgroundColor3 = Color3.fromRGB(26, 29, 36)
cmdFrame.BackgroundTransparency = 0.13
cmdFrame.BorderSizePixel = 0

-- Title bar Main
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 36)
title.Position = UDim2.new(0, 0, 0, 0)
title.Text = "Ultimate Utility GUI"
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 235, 110)

-- Title bar Commands
local cmdTitle = Instance.new("TextLabel", cmdFrame)
cmdTitle.Size = UDim2.new(1, 0, 0, 24)
cmdTitle.Position = UDim2.new(0, 0, 0, 0)
cmdTitle.Text = "Extra Commands"
cmdTitle.Font = Enum.Font.GothamBold
cmdTitle.TextSize = 16
cmdTitle.BackgroundTransparency = 1
cmdTitle.TextColor3 = Color3.fromRGB(255, 235, 110)

-- DRAGGABLE GUI
local UserInputService = game:GetService("UserInputService")
local function makeDraggable(target, ybar)
    local dragging, dragInput, dragStart, startPos = false, nil, nil, nil
    target.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and input.Position.Y - target.AbsolutePosition.Y < ybar then
            dragging = true
            dragStart = input.Position
            startPos = target.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    target.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            target.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end
makeDraggable(frame, 36)
makeDraggable(cmdFrame, 24)

local y = 36
local function makeStatusCircle(parent, color, y)
    local cir = Instance.new("Frame", parent)
    cir.Size = UDim2.new(0, 18, 0, 18)
    cir.Position = UDim2.new(0, 8, 0, y)
    cir.BackgroundColor3 = color
    cir.BorderSizePixel = 0
    cir.Name = "StatusCircle"
    local uicorner = Instance.new("UICorner", cir)
    uicorner.CornerRadius = UDim.new(1,0)
    return cir
end
local statusColors = {
    on = Color3.fromRGB(80,210,80),
    off = Color3.fromRGB(210,50,50)
}

-- Ultimate Utility GUI features (AntiFling, AutoTP, Set Spawn, DiedTP) ... (เหมือนเดิมขอข้ามส่วนนี้)

-- ... (ข้ามไปยัง Freecam)

-- ช่อง GUI สำหรับคำสั่งใหม่

-- ปุ่ม "AntiIdle"
local antiidleBtn = Instance.new("TextButton", cmdFrame)
antiidleBtn.Size = UDim2.new(0, 90, 0, 26)
antiidleBtn.Position = UDim2.new(0, 10, 0, 30)
antiidleBtn.Text = "AntiIdle"
antiidleBtn.Font = Enum.Font.GothamBold
antiidleBtn.TextSize = 13
antiidleBtn.BackgroundColor3 = Color3.fromRGB(56, 100, 125)
antiidleBtn.TextColor3 = Color3.new(1,1,1)
antiidleBtn.BorderSizePixel = 0
antiidleBtn.AutoButtonColor = true

local function run_antiidle()
    local vu = game:GetService("VirtualUser")
    game:GetService("Players").LocalPlayer.Idled:Connect(function()
        vu:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
        wait(1)
        vu:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
    end)
    print("[Ultimate Utility] antiidle enabled: You won't get kicked for being idle/afk.")
end
antiidleBtn.MouseButton1Click:Connect(run_antiidle)

-- ปุ่ม "Freecam" + ปรับสปีด + ตั้งปุ่มลัด
local freecamBtn = Instance.new("TextButton", cmdFrame)
freecamBtn.Size = UDim2.new(0, 90, 0, 26)
freecamBtn.Position = UDim2.new(0, 110, 0, 30)
freecamBtn.Text = "Freecam"
freecamBtn.Font = Enum.Font.GothamBold
freecamBtn.TextSize = 13
freecamBtn.BackgroundColor3 = Color3.fromRGB(56, 100, 125)
freecamBtn.TextColor3 = Color3.new(1,1,1)
freecamBtn.BorderSizePixel = 0
freecamBtn.AutoButtonColor = true

local freecamHotkey = Enum.KeyCode.F
local hotkeyBtn = Instance.new("TextButton", cmdFrame)
hotkeyBtn.Size = UDim2.new(0, 90, 0, 22)
hotkeyBtn.Position = UDim2.new(0, 10, 0, 65)
hotkeyBtn.Text = "Freecam Key: F"
hotkeyBtn.Font = Enum.Font.Gotham
hotkeyBtn.TextSize = 12
hotkeyBtn.BackgroundColor3 = Color3.fromRGB(35, 44, 70)
hotkeyBtn.TextColor3 = Color3.new(1,1,0.7)
hotkeyBtn.BorderSizePixel = 0

hotkeyBtn.MouseButton1Click:Connect(function()
    hotkeyBtn.Text = "กดคีย์..."
    local con
    con = UserInputService.InputBegan:Connect(function(input, gp)
        if not gp and input.KeyCode ~= Enum.KeyCode.Unknown then
            freecamHotkey = input.KeyCode
            hotkeyBtn.Text = "Freecam Key: " .. input.KeyCode.Name
            con:Disconnect()
        end
    end)
end)

local speedLabel = Instance.new("TextLabel", cmdFrame)
speedLabel.Size = UDim2.new(0, 40, 0, 22)
speedLabel.Position = UDim2.new(0, 110, 0, 62)
speedLabel.Text = "Speed:"
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextSize = 12
speedLabel.TextColor3 = Color3.fromRGB(220,220,200)
speedLabel.BackgroundTransparency = 1

local speedBox = Instance.new("TextBox", cmdFrame)
speedBox.Size = UDim2.new(0, 55, 0, 22)
speedBox.Position = UDim2.new(0, 155, 0, 62)
speedBox.Text = "2"
speedBox.TextColor3 = Color3.fromRGB(0,0,0)
speedBox.BackgroundColor3 = Color3.fromRGB(200,220,255)
speedBox.Font = Enum.Font.Gotham
speedBox.TextSize = 12
speedBox.BorderSizePixel = 0

-- Freecam logic (แก้ไข movement ให้ตรงกับกล้อง, และยกเลิกได้ด้วยปุ่ม/คลิก)
local freecamActive = false
local freecamConnections = {}
local function disconnectFreecam()
    for _,v in pairs(freecamConnections) do pcall(function() v:Disconnect() end) end
    freecamConnections = {}
end
local function run_freecam()
    if freecamActive then return end
    freecamActive = true
    local UserInputService = game:GetService("UserInputService")
    local RunService = game:GetService("RunService")
    local Camera = workspace.CurrentCamera
    local lastCFrame = Camera.CFrame
    Camera.CameraType = Enum.CameraType.Scriptable
    Camera.CFrame = lastCFrame
    local speed = tonumber(speedBox.Text) or 2
    local moveVec = Vector3.new()
    local up, down = false, false
    local mouseDelta = Vector2.new()
    local sens = 0.17

    -- Movement state
    local moveState = {
        W = false, S = false, A = false, D = false
    }

    local function getMoveVec()
        local vec = Vector3.new()
        if moveState.W then vec = vec + Vector3.new(0,0,-1) end
        if moveState.S then vec = vec + Vector3.new(0,0,1) end
        if moveState.A then vec = vec + Vector3.new(-1,0,0) end
        if moveState.D then vec = vec + Vector3.new(1,0,0) end
        return vec
    end

    local function onInput(input, gpe)
        if gpe then return end
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.W then moveState.W = true
            elseif input.KeyCode == Enum.KeyCode.S then moveState.S = true
            elseif input.KeyCode == Enum.KeyCode.A then moveState.A = true
            elseif input.KeyCode == Enum.KeyCode.D then moveState.D = true
            elseif input.KeyCode == Enum.KeyCode.Space then up = true
            elseif input.KeyCode == Enum.KeyCode.LeftShift then down = true
            -- ยกเลิก Freecam ด้วยคีย์ลัดที่ตั้งเอง
            elseif input.KeyCode == freecamHotkey then freecamActive = false end
            -- หรือ Esc ก็ยกเลิก
            elseif input.KeyCode == Enum.KeyCode.Escape then freecamActive = false end
        elseif input.UserInputType == Enum.UserInputType.MouseWheel then
            if input.Position.Z > 0 then
                speed = math.min(speed + 0.5, 32)
            elseif input.Position.Z < 0 then
                speed = math.max(speed - 0.5, 0.5)
            end
            speedBox.Text = tostring(math.floor(speed*10)/10)
        end
    end
    local function onInputEnd(input, gpe)
        if gpe then return end
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.W then moveState.W = false
            elseif input.KeyCode == Enum.KeyCode.S then moveState.S = false
            elseif input.KeyCode == Enum.KeyCode.A then moveState.A = false
            elseif input.KeyCode == Enum.KeyCode.D then moveState.D = false
            elseif input.KeyCode == Enum.KeyCode.Space then up = false
            elseif input.KeyCode == Enum.KeyCode.LeftShift then down = false
            end
        end
    end
    local function mouseMove(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            mouseDelta = input.Delta
        end
    end

    pcall(function() UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter end)

    table.insert(freecamConnections, UserInputService.InputBegan:Connect(onInput))
    table.insert(freecamConnections, UserInputService.InputEnded:Connect(onInputEnd))
    table.insert(freecamConnections, UserInputService.InputChanged:Connect(mouseMove))
    table.insert(freecamConnections, speedBox.FocusLost:Connect(function(enter)
        if enter then
            local val = tonumber(speedBox.Text)
            if val then speed = val end
        end
    end))

    table.insert(freecamConnections, RunService.RenderStepped:Connect(function(dt)
        if not freecamActive then
            Camera.CameraType = Enum.CameraType.Custom
            pcall(function() UserInputService.MouseBehavior = Enum.MouseBehavior.Default end)
            disconnectFreecam()
            return
        end
        local yAngle = -mouseDelta.X * sens * dt * 60
        local xAngle = -mouseDelta.Y * sens * dt * 60
        lastCFrame = lastCFrame * CFrame.Angles(0, math.rad(yAngle), 0) * CFrame.Angles(math.rad(xAngle), 0, 0)
        mouseDelta = Vector2.new()
        local move = getMoveVec()
        local dir = Vector3.new()
        if move.Magnitude > 0 then
            dir = ((lastCFrame.LookVector * move.Z) + (lastCFrame.RightVector * move.X)).Unit * move.Magnitude
        end
        if up then dir = dir + lastCFrame.UpVector end
        if down then dir = dir - lastCFrame.UpVector end
        lastCFrame = lastCFrame + dir * (speed * dt * 10)
        Camera.CFrame = lastCFrame
    end))
end
freecamBtn.MouseButton1Click:Connect(run_freecam)
UserInputService.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == freecamHotkey and not freecamActive then
        run_freecam()
    end
end)

-- ปุ่ม "Reset"
local resetBtn = Instance.new("TextButton", cmdFrame)
resetBtn.Size = UDim2.new(0, 90, 0, 26)
resetBtn.Position = UDim2.new(0, 110, 0, 65)
resetBtn.Text = "Reset"
resetBtn.Font = Enum.Font.GothamBold
resetBtn.TextSize = 13
resetBtn.BackgroundColor3 = Color3.fromRGB(56, 100, 125)
resetBtn.TextColor3 = Color3.new(1,1,1)
resetBtn.BorderSizePixel = 0
resetBtn.AutoButtonColor = true

local function run_reset()
    local player = game.Players.LocalPlayer
    if player and player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
        player.Character:FindFirstChildOfClass("Humanoid").Health = 0
        print("[Ultimate Utility] Character reset.")
    else
        warn("[Ultimate Utility] Character or Humanoid not found.")
    end
end
resetBtn.MouseButton1Click:Connect(run_reset)
