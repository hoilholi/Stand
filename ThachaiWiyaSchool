-- วางใน LocalScript (StarterPlayerScripts) หรือรวมกับ GUI เดิมก็ได้
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local freecamActive = false
local freecamSpeed = 2
local camConn, inputConn, inputEndConn, mouseConn

function StartFreecam()
    freecamActive = true
    local lastCFrame = Camera.CFrame
    Camera.CameraType = Enum.CameraType.Scriptable
    Camera.CFrame = lastCFrame

    local moveDir = Vector3.new()
    local speed = freecamSpeed
    local up, down = false, false
    local mouseDelta = Vector2.new()
    local sens = 0.17

    function onInput(input, gpe)
        if gpe then return end
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.F then
                StopFreecam()
            elseif input.KeyCode == Enum.KeyCode.W then moveDir = Vector3.new(0,0,-1)
            elseif input.KeyCode == Enum.KeyCode.S then moveDir = Vector3.new(0,0,1)
            elseif input.KeyCode == Enum.KeyCode.A then moveDir = Vector3.new(-1,0,0)
            elseif input.KeyCode == Enum.KeyCode.D then moveDir = Vector3.new(1,0,0)
            elseif input.KeyCode == Enum.KeyCode.Space then up = true
            elseif input.KeyCode == Enum.KeyCode.LeftShift then down = true
            end
        elseif input.UserInputType == Enum.UserInputType.MouseWheel then
            if input.Position.Z > 0 then speed = speed + 0.5
            elseif input.Position.Z < 0 and speed > 0.5 then speed = speed - 0.5 end
            freecamSpeed = speed
        end
    end
    function onInputEnd(input, gpe)
        if gpe then return end
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.W or input.KeyCode == Enum.KeyCode.S then moveDir = Vector3.new(0,0,0)
            elseif input.KeyCode == Enum.KeyCode.A or input.KeyCode == Enum.KeyCode.D then moveDir = Vector3.new(0,0,0)
            elseif input.KeyCode == Enum.KeyCode.Space then up = false
            elseif input.KeyCode == Enum.KeyCode.LeftShift then down = false
            end
        end
    end
    function mouseMove(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            mouseDelta = input.Delta
        end
    end

    -- Lock mouse to center for better experience
    pcall(function()
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
    end)

    inputConn = UserInputService.InputBegan:Connect(onInput)
    inputEndConn = UserInputService.InputEnded:Connect(onInputEnd)
    mouseConn = UserInputService.InputChanged:Connect(mouseMove)
    camConn = RunService.RenderStepped:Connect(function(dt)
        if not freecamActive then return end
        -- Mouse look
        local yAngle = -mouseDelta.X * sens * dt * 60
        local xAngle = -mouseDelta.Y * sens * dt * 60
        lastCFrame = lastCFrame * CFrame.Angles(0, math.rad(yAngle), 0) * CFrame.Angles(math.rad(xAngle), 0, 0)
        mouseDelta = Vector2.new()
        -- Move
        local move = Vector3.new()
        if moveDir.Z ~= 0 then move = move + lastCFrame.LookVector * moveDir.Z end
        if moveDir.X ~= 0 then move = move + lastCFrame.RightVector * moveDir.X end
        if up then move = move + lastCFrame.UpVector end
        if down then move = move - lastCFrame.UpVector end
        lastCFrame = lastCFrame + move * (speed * dt * 10)
        Camera.CFrame = lastCFrame
    end)
end

function StopFreecam()
    freecamActive = false
    Camera.CameraType = Enum.CameraType.Custom
    pcall(function()
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    end)
    if camConn then camConn:Disconnect() end
    if inputConn then inputConn:Disconnect() end
    if inputEndConn then inputEndConn:Disconnect() end
    if mouseConn then mouseConn:Disconnect() end
end

-- Toggle Freecam (F)
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.F then
        if not freecamActive then
            StartFreecam()
        else
            StopFreecam()
        end
    end
end)
